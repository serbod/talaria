#summary Канал (групповой чат)

<h1>Distributed Network Messaging Protocol</h1>

Коммерческое использование только с разрешения автора.<br>
При использовании необходимо явно указывать ссылку на источник.

<p>Sergey Bodrov, 2010-10-24</p>

<h1>Канал (групповой чат)</h1>


Канал содержит:<br>
<li>Имя, начинающееся с символа "#" (решетка) и не содержащее пробелов.
<li>Описание (топик), представляющее собой строку символов.
<li>Список владельцев
<li>Список абонентов (подписчиков)
<li>Список последних сообщений
<li>"Черный список" абонентов

Запись об абоненте содержит:<br>
<li>GUID абонента
<li>состояние (подключен или отключен)
<li>ник (имя на канале, не зависит от реального имени)
<li>адрес
<li>полномочия (набор полномочий)
<li>статус (сообщение абонента)
<li>аватар (картинка)

Сообщение канала содержит:<br>
<li>дату-время
<li>имя автора
<li>GUID автора
<li>текст сообщения

Запись "черного списка" содержит:<br>
<li>GUID автора
<li>GUID абонента
<li>текст причины
<li>дату-время окончания

<p>При подключении или подписке клиента на канал, он получает описание канала, список других подключенных абонентов и список последних сообщений. Если абонент в "черном списке", то подключение не допускается.</p>

<p>При отправке клиентом сообщения на канал, сообщение направляется на узел сервиса. Сервис перенаправляет сообщение всем абонентам канала и добавляет его с список последних сообщений. Если размер списка последних сообщений превышает заданный, то самое раннее сообщение из списка удаляется.</p>

<p>При отключении абонента, его состояние в списке абонентов меняется на "отключен". При этом запись об абоненте не удаляется из списка подписчиков.</p>

<p>Любое новое сообщение или изменение в списке абонентов пересылается всем абонентам. Если абонентом является узел, то другим абонентам этого узла сообщения не передаются, это делает сам узел-подписчик.</p>


<h2>Формат сообщений DNMP</h2>

<u>Обязаительные реквизиты для всех сообщений</u><br>
Тип: <b>GRPC</b><br>
Параметры:<br>
<b>name</b> - название группы (канала)<br>

<u>Сообщение на канал</u><br>
Параметры:<br>
<b>author_name</b> - имя автора сообщения<br>
<b>author_guid</b> - GUID автора сообщения<br>
<b>timestamp</b> - таймштамп сообщения<br>
Данные:<br>
текст сообщения<br>

<u>Команда сервису</u><br>
Параметры:<br>
<b>cmd</b> - команда<br>
Данные:<br>
параметры команды<br>

<u>Данные</u><br>
Параметры:<br>
<b>data</b> - тип данных<br>
Данные:<br>
содержимое данных<br>

<h3>Команды:</h3>
(S) - Cервис на узле<br>
(C) - Клиент<br>
(SС) - Сервис на узле и клиент<br>


JOIN <GUID_абонента> {{{[текст]}}}<br>
(S) Если абонент не в "черном списке", то добавляем абонента в список подписчиков
и пользователей канала. Затем отправляем абоненту информацию о канале (тема, 
режимы), список пользователей, последние сообщения.<br>
(C) Добавляет абонента в список подписчиков и пользователей канала.<br>

LEAVE <GUID_абонента> {{{[текст]}}}<br>
(SС) Убирает абонента из списка подписчиков и пользователей канала.

SET_TOPIC <текст><br>
(S) Устанавливает тему канала

GET_TOPIC<br>
(S) Возвращает сообщение, содержащее заголовок (тему) канала.

GET_USERS<br>
(S) Возвращает список активных подписчиков

GET_ABONENTS<br>
(S) Возвращает список всех подписчиков

GET_LAST_MESSAGES {{{[число сообщений]}}}<br>
(S) Возвращает последние сообщения

GET_MODE<br>
(S) Возвращает строку режимов канала

SET_MODE<br>
(SC) Устанавливает один или несколько режимов канала

KICK <GUID_абонента> {{{[причина]}}}<br>
(SC) Убирает абонента из списка подписчиков с указанием причины

BAN <GUID_абонента> <срок> {{{[причина]}}}<br>
(SC) Добавляет абонента в "черный список" на заданый срок в указанием причины.

UNBAN <UID_абонента><br>
(SC) Удаляет абонента из "черного списка".

GET_BANLIST<br>
(S) Возвращает "черный список" абонентов

SAY <GUID_абонента> <текст><br>
(SC) Сообщение на канал от абонента

RENAME <GUID_абонента> <новое_имя><br>
(SC) Переименование абонента

SET_STATE <GUID_абонента> <признак_состояния> {{{[текст состояния]}}}<br>
(SC) Установка состояния абонента



<h3>Данные:</h3>

TOPIC - тема канала<br>
Содержит текст темы канала

USERS - список активных подписчиков<br>
Содержит сериализованный список контактов активных подписчиков.

ABONENTS - список всех подписчиков<br>
Состав данных тот же, что и в USERS

BANLIST - список абонентов, помещенных в "черный список"<br>
<b>author_guid</b> - GUID автора<br>
<b>abonent_guid</b> - GUID абонента<br>
<b>end_date</b> - дата-время окончания<br>
<b>reason</b> - текст причины<br>

MODE - режимы канала<br>
содержит строку режимов канала

STATE - состояние абонента<br>
содержит признак состояния и текст состояния вида:<br>
<GUID_абонента> <признак_состояния> {{{[текст состояния]}}}<br>
Признаки состояния:<br>
ON - онлайн<br>
OFF - оффлайн<br>
AFK - онлайн, недоступен<br>
BUSY - онлайн, занят (не беспокоить)<br>
Возможны и другие варианты признака состояния.<br>