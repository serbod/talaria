#summary DNMP - описание основных действий

<h2>Distributed Network Messaging Protocol</h2>

Коммерческое использование только с разрешения автора.<br>
При использовании необходимо явно указывать ссылку на источник.

<p>Sergey Bodrov, 2015-01-20</p>

<wiki:toc max_depth="3" />

=DNMP - описание основных действий=

==Подключение, авторизация==

  * Хозяин -> Гость
Контактные данные хозяина, тестовая фраза (строка случайных символов)

  * Гость -> Хозяин
Контактные данные гостя и тестовая фраза, шифрованная ключом
 Если ключа нет, то ключом становится тестовая фраза

  * Хозяин -> Гость
результат опознания
 Если гость известен, расшифровываем ключом ответ гостя, сравниваем с отправленной ранее тестовой фразой
 Если ключа нет, то ключом становится тестовая фраза
 Если гость неизвестен, то он добавляется в список контактов, требующих подтверждения


==После успешной авторизации==

===Обновление статуса контакта===

  * Гость
Меняет статус - online или busy

  * Хозяин -> Гость
Запрос детальных сведений о контакте INFO GINF

  * Гость -> Хозяин
Детальные сведения о контакте INFO CINF
Полученый Статус должен быть не offline

  * Хозяин
Рассылает линкам (кроме Гостя) уведомления о новом статусе Гостя INFO UPDI

{{{ Нужна оптимизация, чтобы не спамить уведомлениями. Накапливать уведомления и рассылать пакетами. Рассылать только подписчикам Гостя. }}}

===Обновление таблиц маршрутизации===

  * Гость -> Хозяин
Список своих узлов-даунлинков (downlink nodes), включая вложенные. Хозяин добавляет полученные узлы в свою таблицу маршрутизации.

===Передача отложенных сообщений===

{{{ Как бы это лучше сделать? По запросу клиента с возможностью выбора (как в почтовых сервисах) или автоматом с возможностью отмены (как в чатах) }}}

  * Хозяин -> Гость
Отложенные сообщения (если есть)

  * Гость -> Хозяин
Гость может отменить прием отложенных сообщений INFO CLIN

===Обновление нодлиста===

{{{ Не всегда есть необходимость каждый раз обновлять нодлист. Только если он меньше NN узлов или не обновлялся NN дней. }}}

  * Гость -> Хозяин
Запрос нодлиста INFO NLRQ

  * Хозяин -> Гость
Нодлист INFO NLST

{{{ Нодлист может быть очень большим. Может поинтам выдавать только часть нодлиста? }}}

===Обновление сервисов===

  * Гость -> Хозяин
Запрос списка сервисов SRVD GET_TYPES

  * Гость -> Хозяин
Запрос обновлений по подписанным сервисам


==После разрыва соединения==

Если нет активных подключений (линков), то всем контактам статус uncnown, себе статус offline.

Если отключившимся Гостем был наш поинт, то его контакту статус offline, всем линкам рассылка уведомления о статусе контакта.

Если отключившимся Гостем был узел, то:
 - отправляем аплинку сообщение об изменении маршрутизации со списком узлов, которые были у данного аплинка (из таблицы маршрутов)
 - удаляем из таблицы маршрутизации ветку маршрутов данного узла