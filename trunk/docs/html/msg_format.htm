<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
<title>DNMP - формат сообщений</title>
<link href="ice.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<title>Формат сообщений</title>
<p><b>Distributed Network Messaging Protocol</b></p>

<p>Коммерческое использование только с разрешения автора.<br>
При использовании необходимо явно указывать ссылку на источник.</p>

<p>Sergey Bodrov, 2008-12-26</p>

<p><b>Формат сообщений</b></p>

<center><img src="pics/dnmp_msg.png" /></center>

<p>Описание имеет вид:<br>
число_байт - описание<br>
ХХ - переменное число байт</p>

<p>Размер указывает число байтов, следующих за самим размером. Например, размер сообщения 80 байт, это значит, что сначала идет указатель размера (4 байта), а потом само сообщение (80 байт).</p>

<p>Служебная информация представляет собой набор строк имя=значение, разделенных символами перевода строки (CR+LF). Все значения в строковом виде.</p>

<p><u>Все сообщения имеют формат:</u></p>
04 - размер сообщения<br>
04 - тип сообщения<br>
04 - таймштамп<br>
08 - адрес отправителя<br>
08 - адрес получателя<br>
04 - смещение от начала до синбаев (размер содержимого + 24 байта)<br>
04 - размер служебной информации<br>
XX - служебная информация<br>
04 - размер содержимого сообщения<br>
XX - содержимое сообщения<br>
XX - синбаи (по 4 байта)<br>

<newpage>
<title>Сообщения между пользователями</title>
<p><u><b>Сообщения между пользователями</b></u></p>

<p>
<u>Приват-чат:</u><br>
Тип: <b>CHAT</b><br>
Параметры:<br>
нет<br>
Данные:<br>
текст сообщения<br>
</p>

<p>
<u>Приват:</u><br>
Тип: <b>MAIL</b><br>
Параметры:<br>
<b>source_timestamp</b> - таймштамп исходного сообщения<br>
<b>header</b> - заголовок<br>
Данные:<br>
текст сообщения<br>
</p>

<p>
<u>Сообщение на канал:</u><br>
Тип: <b>GRPC</b><br>
Параметры:<br>
<b>group</b> - название группы<br>
Данные:<br>
текст сообщения<br>
</p>

<p>
<u>Сообщение на форум:</u><br>
Тип: <b>FORU</b><br>
Параметры:<br>
<b>group</b> - название группы<br>
<b>header</b> - заголовок<br>
Данные:<br>
текст сообщения<br>
</p>

<newpage>
<title>Передача файла получателю</title>
<p><u><b>Передача файла получателю</b></u></p>

<p>
<u>Заголовок файла:</u><br>
Тип: <b>FILE</b><br>
Параметры:<br>
<b>file_id</b> - ID файла<br>
<b>file_name</b> - название файла<br>
<b>file_size</b> - размер файла<br>
<b>file_time</b> - время файла (UNIX-time)<br>
<b>segment_size</b> - размер сегмента<br>
<b>segment_count</b> - число сегментов<br>
<b>md5</b> - хеш файла MD5<br>
Данные:<br>
содержимое файла (первый сегмент)<br>
</p>

<p>
<u>Сегмент файла:</u><br>
Тип: <b>FSEG</b><br>
Параметры:<br>
<b>file_id</b> - ID файла<br>
<b>segment_number</b> - номер сегмента<br>
<b>segment_size</b> - размер сегмента<br>
Данные:<br>
содержимое файла (сегмент)<br>
</p>

<p>
<u>Запрос сегмента:</u><br>
Тип: <b>SREQ</b><br>
Параметры:<br>
<b>file_id</b> - ID файла<br>
<b>segment_number</b> - номер сегмента<br>
Данные:<br>
нет<br>
</p>

<newpage>
<title>Подключение, авторизация</title>
<p><u><b>Подключение, авторизация</b></u></p>

При подключении точки к узлу, узел генерирует случайный ключ (ключ опознания) и передает его подключившемуся вместе с информацией о себе. В качестве адреса подключившегося используется адрес 0.0

<p>
<u>Запрос авторизации (Authentication Request):</u><br>
Тип: <b>AURQ</b><br>
Параметры:<br>
<b>name</b> - название узла<br>
<b>owner</b> - информация о владелеце узла<br>
Данные:<br>
ключ опознания<br>
</p>

Точка шифрует полученный ключ опознания своим ключом и отправляет обратно вместе с информацией о себе.

<p>
<u>Ответ на запрос авторизации (Authentication Reply):</u><br>
Тип: <b>ARPL</b><br>
Параметры:<br>
<b>name</b> - название узла<br>
<b>owner</b> - информация о владелеце узла<br>
Данные:<br>
шифрованый ключ опознания<br>
</p>

Узел получает ответ и ищет паспорт точки в списке известных линков по ее адресу или GUID. Если найден, то сервер шифрует ключ опознания известным ему ключом клиента и сравнивает результат с полученым от линка. Если шифры совпадают, значит линк опознан и возвращается результат "ОК". Если ключи не совпадают, значит клиент не опознан и требует ручного подтверждения авторизации. После ручного подтверждения ключ опознания становится ключом клиента.

<p>
<u>Результат опознания (Authentication Result):</u><br>
Тип: <b>ARSL</b><br>
Параметры:<br>
<b>auth_result</b> - результат опознания<br>
Данные:<br>
нет<br>
</p>

<newpage>
<title>Обмен сведениями об узлах и точках</title>
<p><u><b>Обмен сведениями об узлах и точках</b></u></p>

Для построения карты сегмента можно запросить узел об его линках

<p>
<u>Запрос списка линков (Links Request):</u><br>
Тип: <b>LNRQ</b><br>
Параметры:<br>
нет<br>
Данные:<br>
нет<br>
</p>

<p>
<u>Запрос поинтлиста (Pointlist Request):</u>
Тип: <b>PNRQ</b><br>
Параметры:<br>
нет<br>
Данные:<br>
нет<br>
</p>

Можно запросить у узла подробную информацию об одном из его поинтов по адресу или части имени.

<p>
<u>Получить информацию об адресе или имени (Get Info): </u><br>
Тип: <b>GINF</b><br>
Параметры:<br>
<b>addr</b> - адрес<br>
<b>name</b> - название<br>
Данные:<br>
нет<br>
</p>

Подробная информация возвращается тому, кто ее запросил.

<p>
<u>Информация линка (Link Info):</u><br>
Тип: <b>LNKI</b><br>
Параметры:<br>
<b>addr</b> - адрес узла<br>
<b>name</b> - название узла<br>
<b>owner</b> - информация о владельце узла<br>
<b>ip_addr</b> - IP-адрес узла<br>
<b>phone_no</b> - номер телефона узла<br>
<b>rating</b> - рейтинг узла<br>
Данные:<br>
нет<br>
</p>

<newpage>
<title>Служебные сообщения</title>
<p><u><b>Служебные сообщения</b></u></p>

<p>
<u>Сообщение об ошибке (Error Report)</u><br>
Тип: <b>ERRR</b><br>
Параметры:<br>
<b>err_code</b> - код ошибки<br>
<b>err_text</b> - текст сообщения об ошибке<br>
<b>source_timestamp</b> - таймштамп исходного сообщения<br>
Данные:<br>
исходное сообщение целиком<br>
</p>

<p><u>Информационное сообщение</u></p>
Запрос информации, подтверждение доставки сообщения, ответ на запрос, итд..
<p>
Тип: <b>INFO</b><br>
Параметры:<br>
<b>info_type</b> - вид информации в сообщении<br>
<b>source_timestamp</b> - таймштамп исходного сообщения<br>
Данные:<br>
нет<br>
</p>

</body>
</html>